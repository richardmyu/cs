# 集合运算

## 表的加减法

### 什么是集合运算

**集合** 在数学领域表示“（各种各样的）事物的总和”，在数据库领域表示 **记录的集合**。具体来说，表、视图和查询的执行结果都是记录的集合。

所谓 **集合运算**，就是对满足同一规则的记录进行的加减等四则运算。通过集合运算，可以得到两张表中记录的集合或者公共记录的集合，又或者其中某张表中的记录的集合。像这样用来进行集合运算的运算符称为 **集合运算符**。

### 表的加法 —— UNION（并集）

进行记录加法运算的 **UNION**（并集）。

```sql
SELECT product_id, product_name
  FROM Product
UNION
SELECT product_id, product_name
  FROM Product2;
```

`UNION` 等集合运算符通常都会除去重复的记录。

### 集合运算的注意事项

> 所有运算符都要遵守这些注意事项。

- 作为运算对象的记录的列数必须相同
>
- 作为运算对象的记录中列的类型必须一致
>
- 可以使用任何 `SELECT` 语句，但 `ORDER BY` 子句只能在最后使用一次

```sql
-- 列数不一致时会发生错误
SELECT product_id, product_name
  FROM Product
UNION
SELECT product_id, product_name, sale_price
  FROM Product2;
/*
错误：每一个 UNION 查询必须有相同的字段个数
第 4 行 SELECT product_id, product_name, sale_price
*/

-- 数据类型不一致时会发生错误
SELECT product_id, sale_price
  FROM Product
UNION
SELECT product_id, regist_date
  FROM Product2;
/*
错误：UNION 的类型 integer 和 date 不匹配
第 4 行 SELECT product_id, regist_date
*/

SELECT product_id, product_name
  FROM Product
 WHERE product_type = '厨房用具'
UNION
SELECT product_id, product_name
  FROM Product2
 WHERE product_type = '厨房用具'
 ORDER BY product_id;
```

### 包含重复行的集合运算 —— ALL 选项

在 `UNION` 的结果中保留重复行的语法。其实非常简单，只需要在 `UNION` 后面添加 `ALL` 关键字就可以了。这里的 `ALL` 选项，在 `UNION` 之外的集合运算符中同样可以使用。

```sql
SELECT product_id, product_name
  FROM Product
UNION ALL
SELECT product_id, product_name
  FROM Product2;
```

### 选取表中公共部分 —— INTERSECT（交集）

选取两个记录集合中公共部分的 **INTERSECT**（交集）。

```sql
SELECT product_id, product_name
  FROM Product
INTERSECT
SELECT product_id, product_name
  FROM Product2
ORDER BY product_id;
```

与使用 `AND` 可以选取出一张表中满足多个条件的公共部分不同，`INTERSECT` 应用于两张表，选取出它们当中的公共记录。

### 记录的减法 —— EXCEPT

进行减法运算的 **EXCEPT**（差集）。

```sql
SELECT product_id, product_name
  FROM Product
EXCEPT
SELECT product_id, product_name
  FROM Product2
ORDER BY product_id;
```

`EXCEPT` 有一点与 `UNION` 和 `INTERSECT` 不同，需要注意一下。那就是在减法运算中减数和被减数的位置不同，所得到的结果也不相同。

## 联结（以列为单位对表进行联结）

### 什么是联结

集合运算的特征就是以行方向为单位进行操作。通俗地说，就是进行这些集合运算时，会导致记录行数的增减，但是这些运算不会导致列数的改变。

**联结**（JOIN）运算，简单来说，*就是将其他表中的列添加过来，进行“添加列”的运算*。该操作通常用于无法从一张表中获取期望数据（列）的情况。

### 内联结 —— INNER JOIN

**内联结**（INNER JOIN），是应用最广泛的联结运算。

```sql
SELECT SP.shop_id, SP.shop_name, P.product_id, P.product_name, P.sale_price
  FROM ShopProduct AS SP INNER JOIN Product AS P
    ON SP.product_id = P.product_id;
```

关于内联结，注意以下三点：

1. **FROM 子句**

```sql
FROM ShopProduct AS SP INNER JOIN Product AS P
```

使用关键字 `INNER JOIN` 就可以将两张表联结在一起了。SP 和 P 分别是这两张表的别名，但别名并不是必需的。

2. **ON 子句**

在 `ON` 之后指定两张表联结所使用的列（联结键）。也就是说，`ON` 是专门用来指定联结条件的，它能起到与 `WHERE` 相同的作用。需要指定多个键时，同样可以使用 `AND`、`OR`。在进行内联结时 `ON` 子句是必不可少的（如果没有 `ON` 会发生错误），并且 `ON` 必须书写在 `FROM` 和 `WHERE` 之间。

> 联结条件也可以使用“`=`”来记述。在语法上，还可以使用 `<=` 和 `BETWEEN` 等谓词。

3. **SELECT 子句**

使用联结时 `SELECT` 子句中的列需要按照“`<表的别名>.<列名>`”的格式进行书写。从语法上来说，只有那些同时存在于两张表中的列必须使用这样的书写方式，其他的列这样直接书写列名也不会发生错误。

```sql
SELECT SP.shop_id, SP.shop_name, P.product_id, P.product_name, P.sale_price
  FROM ShopProduct AS SP INNER JOIN Product AS P
    ON SP.product_id = P.product_id
 WHERE SP.shop_id = '000A';
```

> 像这样使用联结运算将满足相同规则的表联结起来时，`WHERE`、`GROUP BY`、`HAVING`、`ORDER BY` 等工具都可以正常使用。

### 外联结 —— OUTER JOIN

内联结之外比较重要的就是 **外联结**（OUTER JOIN）了。

外联结也是通过 `ON` 子句的联结键将两张表进行联结，并从两张表中同时选取相应的列的。基本的使用方法并没有什么不同，只是结果却有所不同。

```sql
SELECT SP.shop_id, SP.shop_name, P.product_id, P.product_name, P.sale_price
  FROM ShopProduct AS SP RIGHT OUTER JOIN Product AS P
    ON SP.product_id = P.product_id;
```

#### 外联结要点

1. **选取出单张表中全部的信息**

内联结只能选取出同时存在于两张表中的数据，对于外联结来说，只要数据存在于某一张表当中，就能够读取出来。

> 外联结名称的由来也跟 `NULL` 有关，即“结果中包含原表中不存在（在原表之外）的信息”。相反，只包含表内信息的联结也就被称为内联结了。

1. **每张表都是主表吗**

外联结还有一点非常重要，那就是要把哪张表作为主表。最终的结果中会包含主表内所有的数据。指定主表的关键字是 `LEFT` 和 `RIGHT`。顾名思义，使用 `LEFT` 时 `FROM` 子句中写在左侧的表是主表，使用 `RIGHT` 时右侧的表是主表。

### 3 张以上的表的联结

原则上联结表的数量并没有限制。

```sql
SELECT SP.shop_id, SP.shop_name, P.product_id, P.product_name, P.sale_price, IP.inventory_quantity
  FROM ShopProduct AS SP INNER JOIN Product AS P
    ON SP.product_id = P.product_id
          INNER JOIN InventoryProduct AS IP
             ON SP.product_id = IP.product_id
WHERE IP.inventory_id = 'P001';
```

### 交叉联结 —— CROSS JOIN（笛卡儿积）

**交叉联结**（CROSS JOIN），是所有联结运算的基础，但其实这种联结在实际业务中并不会使用。

```sql
SELECT SP.shop_id, SP.shop_name, P.product_id, P.product_name
  FROM ShopProduct AS SP CROSS JOIN Product AS P;
```

对满足相同规则的表进行交叉联结的集合运算符是 `CROSS JOIN`（**笛卡儿积**）。进行交叉联结时无法使用内联结和外联结中所使用的 `ON` 子句，这是因为交叉联结是对两张表中的全部记录进行交叉组合，因此结果中的记录数通常是两张表中行数的乘积。

内联结是交叉联结的一部分，“内”也可以理解为“包含在交叉联结结果中的部分”。相反，外联结的“外”可以理解为“交叉联结结果之外的部分”。

交叉联结没有应用到实际业务之中的原因有两个。一是其结果没有实用价值，二是由于其结果行数太多，需要花费大量的运算时间和高性能设备的支持。

### 关系除法

集合运算中的除法通常称为关系除法。关系是数学领域中对表或者视图的称谓，但是并没有定义像 `UNION` 或者 `EXCEPT` 这样专用的运算符。

```sql
SELECT DISTINCT emp
  FROM EmpSkills AS ES1
WHERE NOT EXISTS
      (SELECT skill
          FROM Skills
       EXCEPT
       SELECT skill
       FROM EmpSkills AS ES2
    WHERE ES1.emp=ES2.emp);
```
