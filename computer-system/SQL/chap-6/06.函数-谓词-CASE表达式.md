# 函数、谓词、CASE 表达式

[TOC]

## 1.函数

### 1.1.函数的种类

函数大致可以分为以下几种。

1. 算术函数（用来进行数值计算的函数）
2. 字符串函数（用来进行字符串操作的函数）
3. 日期函数（用来进行日期操作的函数）
4. 转换函数（用来转换数据类型和值的函数）
5. 聚合函数（用来进行数据聚合的函数）

> 聚合函数基本上只包含 `COUNT`、`SUM`、`AVG`、`MAX`、`MIN` 这 5 种，而其他种类的函数总数则超过 200 种。虽然数量众多，但常用函数只有 30 ~ 50 个。

### 1.2.算数函数

`NUMERIC` 是大多数 DBMS 都支持的一种数据类型，通过 `NUMBERIC` ( 全体位数，小数位数 ) 的形式来指定数值的大小。

- **`ABS` 函数**

`ABS` 是计算绝对值的函数。绝对值（absolute value）不考虑数值的符号，表示一个数到原点的距离。简单来讲，绝对值的计算方法就是：0 和正数的绝对值就是其本身，负数的绝对值就是去掉符号后的结果。

```sql
SELECT m,
       ABS(m) AS abs_col
  FROM SampleMath;
```

> ABS 函数的参数为 `NULL` 时，结果也是 `NULL`。并非只有 `ABS` 函数如此，其实绝大多数函数对于 `NULL` 都返回 `NULL`（但是转换函数中的 `COALESCE` 函数除外）。

- **`MOD` 函数**

`MOD` 是计算除法余数（求余）的函数，是 modulo 的缩写。因为小数计算中并没有余数的概念，所以只能对整数类型的列使用 `MOD` 函数。

```sql
SELECT n, p,
       MOD(n, p) AS mod_col
  FROM SampleMath;
```

> 主流的 DBMS 都支持 `MOD` 函数，只有 SQL Server 不支持该函数。

- **`ROUND` 函数**

`ROUND` 函数用来进行四舍五入操作。

```sql
SELECT m, n,
       ROUND(m, n) AS round_col
  FROM SampleMath;
```

### 1.3.字符串函数

- **`||` 函数**

在 SQL 中，可以通过由两条并列的竖线变换而成的“`||`”函数来实现字符串的拼接。

```sql
SELECT str1, str2, str1||str2 AS str_concat
FROM SampleStr;
```

> `||` 函数在 SQL Server 和 MySQL 中无法使用。SQL Server 使用 `+` 运算符（函数）来连接字符串。MySQL 使用 `CONCAT` 函数来完成字符串的拼接。

- **`LENGTH` 函数**

想要知道字符串中包含多少个字符时，可以使用 `LENGTH`（长度）函数。

```sql
SELECT str1, LENGTH(str1) AS len_str
FROM SampleStr;
```

> SQL Server 使用 `LEN` 函数来计算字符串的长度。

- **`LOWER/UPPER` 函数**

`LOWER` 函数只能针对英文字母使用，它会将参数中的字符串全都转换为小写，`UPPER` 就是大写转换函数。

```sql
SELECT str1, LOWER(str1) AS low_str
FROM SampleStr;
```

- **`REPLACE` 函数**

使用 `REPLACE` 函数，可以将字符串的一部分替换为其他的字符串。

```sql
-- REPLACE（对象字符串，替换前的字符串，替换后的字符串）
SELECT str1, str2, str3, REPLACE(str1,str2,str3) AS rep_str
FROM SampleStr;
```

- **`SUBSTRING` 函数**

> `SUBSTRING` 函数的语法是标准 SQL 承认的正式语法，但是现在只有 PostgreSQL 和 MySQL 支持该语法。

使用 `SUBSTRING` 函数可以截取出字符串中的一部分字符串。截取的起始位置从字符串最左侧开始计算。

```sql
-- SUBSTRING（对象字符串 FROM 截取的起始位置 FOR 截取的字符数）
SELECT str1, SUBSTRING(str1 FROM 3 FOR 2) AS sub_str
FROM SampleStr;
```

### 1.4.日期函数

虽然 SQL 中有很多日期函数，但是其中大部分都依存于各自的 DBMS。

- **`CURRENT_DATE` 函数**

返回 SQL 执行的日期，也就是该函数执行时的日期。由于没有参数，因此无需使用括号。

```sql
SELECT CURRENT_DATE;
```

> 无法在 SQL Server 中执行。此外，Oracle 和 DB2 中的语法略有不同。

- **`CURRENT_TIME` 函数**

`CURRENT_TIME` 函数能够取得 SQL 执行的时间，也就是该函数执行时的时间。由于该函数也没有参数，因此同样无需使用括号。

> 同样无法在 SQL Server 中执行，在 Oracle 和 DB2 中的语法同样略有不同。

- **`CURRENT_TIMESTAMP` 函数**

`CURRENT_TIMESTAMP` 函数具有 `CURRENT_DATE` + `CURRENT_TIME` 的功能。使用该函数可以同时得到当前的日期和时间，当然也可以从结果中截取日期或者时间。

> 在 Oracle 和 DB2 中该函数的语法略有不同。

- **`EXTRACT` 函数**

使用 `EXTRACT` 函数可以截取出日期数据中的一部分，例如“年”“月”，或者“小时”“秒”等。该函数的返回值并不是日期类型而是数值类型。

```sql
-- EXTRACT（日期元素 FROM 日期）
SELECT CURRENT_TIMESTAMP,
       EXTRACT(YEAR   FROM CURRENT_TIMESTAMP)  AS year,
       EXTRACT(MONTH  FROM CURRENT_TIMESTAMP)  AS month,
       EXTRACT(DAY    FROM CURRENT_TIMESTAMP)  AS day,
       EXTRACT(HOUR   FROM CURRENT_TIMESTAMP)  AS hour,
       EXTRACT(MINUTE FROM CURRENT_TIMESTAMP)  AS minute,
       EXTRACT(SECOND FROM CURRENT_TIMESTAMP)  AS second;
```

> 需要注意的是 SQL Server 也无法使用该函数。SQL Server 使用 `DATEPART` 函数代替。

### 1.5.转换函数

“转换”这个词的含义非常广泛，在 SQL 中主要有两层意思：

1. 一是数据类型的转换，简称为类型转换，在英语中称为 `cast` ；
>
2. 另一层意思是值的转换。

- **`CAST` 函数**

```sql
-- CAST（转换前的值 AS 想要转换的数据类型）

-- SQL Server  PostgreSQL
SELECT CAST('0001' AS INTEGER) AS int_col;

-- MySQL
SELECT CAST('0001' AS SIGNED INTEGER) AS int_col;

-- Oracle
SELECT CAST('0001' AS INTEGER) AS int_col
  FROM DUAL;
```

- **`COALESCE` 函数**

`COALESCE` 是 SQL 特有的函数。该函数会返回可变参数中左侧开始第 1 个不是 `NULL` 的值。参数个数是可变的，因此可以根据需要无限增加。

```sql
-- COALESCE（数据 1，数据 2，数据 3……)

-- SQL Server  PostgreSQL  MySQL
SELECT COALESCE(NULL, 1)                  AS col_1,
       COALESCE(NULL, 'test', NULL)       AS col_2,
       COALESCE(NULL, NULL, '2009-11-01') AS col_3,
       COALESCE(NULL, 'test', '2009-11-01') AS col_4;
```

## 2.谓词

### 2.1.什么是谓词

通俗来讲 **谓词**（predicate）就是函数中的一种，*是需要满足特定条件（返回值是真值）的函数*。对通常的函数来说，返回值有可能是数字、字符串或者日期等，但是谓词的返回值全都是真值（`TRUE/FALSE/UNKNOWN`）。这也是谓词和函数的最大区别。

### 2.2.`LIKE` 谓词--字符串的部分一致查询

部分一致大体可以分为前方一致、中间一致和后方一致三种类型。

- 前方一致：起始部分相同
- 中间一致：含有（包含前方一致、后方一致）
- 后方一致：末尾部分相同

以字符串中是否包含该条件的规则为基础的查询称为 **模式匹配**，其中的模式也就是前面提到的“规则”。

```sql
-- 前方一致
SELECT * FROM SampleLike WHERE strcol LIKE 'ddd%';

-- 中间一致
SELECT * FROM SampleLike WHERE strcol LIKE '%ddd%';

-- 后方一致
SELECT * FROM SampleLike WHERE strcol LIKE '%ddd';
```

> `%` 是代表 “0 字符以上的任意字符串”的特殊符号。可以使用 `_`（下划线）来代替 `%`，代表 “任意 1 个字符”。

### 2.3.`BETWEEN` 谓词 -- 范围查询

使用 `BETWEEN` 可以进行范围查询。该谓词与其他谓词或者函数的不同之处在于它使用了 3 个参数。

```sql
SELECT product_name, sale_price
  FROM Product
 WHERE sale_price BETWEEN 100 AND 1000;
```

`BETWEEN` 的特点就是结果中会包含 100 和 1000 这两个临界值。如果不想让结果中包含临界值，那就必须使用 `<` 和 `>`。

### 2.4.`IS NULL`、`IS NOT NULL` -- 判断是否为 `NULL`

为了选取出某些值为 `NULL` 的列的数据，只能使用特定的谓词 **IS NULL**。与此相反，想要选取 `NULL` 以外的数据时，需要使用 **IS NOT NULL**。

### 2.5.`IN` 谓词 -- `OR` 的简便使用

```sql
-- OR
SELECT product_name, purchase_price
  FROM Product
 WHERE purchase_price =  320
    OR purchase_price =  500
    OR purchase_price = 5000;

-- IN
SELECT product_name, purchase_price
  FROM Product
 WHERE purchase_price IN (320, 500, 5000);

-- AND
SELECT product_name, purchase_price
  FROM Product
 WHERE purchase_price <>  320
    AND purchase_price <>  500
    AND purchase_price <> 5000;

-- NOT IN
SELECT product_name, purchase_price
  FROM Product
 WHERE purchase_price NOT IN (320, 500, 5000);
```

> 需要注意的是，在使用 `IN` 和 `NOT IN` 时是无法选取出 `NULL` 数据的。

### 2.6.使用子查询作为 `IN` 谓词的参数

`IN` 谓词（`NOT IN` 谓词）具有其他谓词所没有的用法，那就是可以使用子查询作为其参数。

> `IN` 的否定形式 `NOT IN` 同样可以使用子查询作为参数，其语法也和 `IN` 完全一样。

```sql
SELECT product_name, sale_price
  FROM Product
 WHERE product_id IN (SELECT product_id
                         FROM ShopProduct
                        WHERE shop_id = '000C');
```

### 2.7.`EXIST` 谓词

一言以蔽之，谓词的作用就是“判断是否存在满足某种条件的记录”。如果存在这样的记录就返回真（TRUE），如果不存在就返回假（FALSE）。 `EXIST`（存在）谓词的主语是“记录”。

```sql
SELECT product_name, sale_price
  FROM Product AS P
  -- EXIST 只需要在右侧书写 1 个参数，该参数通常都会是一个（关联）子查询。
 WHERE EXISTS (SELECT *
                  FROM ShopProduct AS SP
                 WHERE SP.shop_id = '000C'
                   AND SP.product_id = P.product_id);
```

就像 `EXIST` 可以用来替换 `IN` 一样，`NOT IN` 也可以用 `NOT EXIST` 来替换。

```sql
SELECT product_name, sale_price
  FROM Product AS P
 WHERE NOT EXISTS (SELECT *
                      FROM ShopProduct AS SP
                     WHERE SP.shop_id = '000A'
                       AND SP.product_id = P.product_id);
```

## 3.`CASE` 表达式

### 3.1.什么是 `CASE` 表达式

`CASE` 表达式是一种进行运算的功能。这就意味着 `CASE` 表达式也是函数的一种。

`CASE` 表达式是在区分情况时使用的，这种情况的区分在编程中通常称为（条件）分支。

### 3.2.`CASE` 表达式的语法

`CASE` 表达式的语法分为 **简单 `CASE` 表达式** 和 **搜索 `CASE` 表达式** 两种。

- **简单 `CASE` 表达式**

简单 `CASE` 表达式比搜索 `CASE` 表达式简单，但是会受到条件的约束，因此通常情况下都会使用搜索 `CASE` 表达式。

```sql
CASE <表达式>
    WHEN <表达式> THEN <表达式>
    WHEN <表达式> THEN <表达式>
    WHEN <表达式> THEN <表达式>
        .
        .
        .
    ELSE <表达式>
END
```

`WHEN` 子句中的 `<求值表达式>` 就是类似 `列 = 值` 这样，返回值为真值（`TRUE/FALSE/UNKNOWN`）的表达式。我们也可以将其看作使用 `=`、`!=` 或者 `LIKE`、`BETWEEN` 等谓词编写出来的表达式。

`CASE` 表达式会从对最初的 `WHEN` 子句中的“`<求值表达式>`”进行求值开始执行。所谓求值，就是要调查该表达式的真值是什么。如果结果为真（TRUE），那么就返回 `THEN` 子句中的表达式，`CASE` 表达式的执行到此为止。如果结果不为真，那么就跳转到下一条 `WHEN` 子句的求值之中。如果直到最后的 `WHEN` 子句为止返回结果都不为真，那么就会返回 `ELSE` 中的表达式，执行终止。

```sql
SELECT product_name,
      CASE product_type
      WHEN '衣服'     THEN 'A ：' || product_type
      WHEN '办公用品'  THEN 'B ：' || product_type
      WHEN '厨房用具'  THEN 'C ：' || product_type
      ELSE NULL
      END AS abc_product_type
FROM Product;
```

简单 `CASE` 表达式在将想要求值的表达式书写过一次之后，就无需在之后的 `WHEN` 子句中重复书写了。虽然看上去简化了书写，但是想要在 `WHEN` 子句中指定不同列时，简单 `CASE` 表达式就无能为力了。

- **搜索 `CASE` 表达式**

与简单 `CASE` 表达式一样，搜索 `CASE` 表达式也是从最初的 `WHEN` 子句开始进行，逐一判断每个 `WHEN` 子句直到返回真值为止。此外，没有能够返回真值的 `WHEN` 子句时，也会返回 `ELSE` 子句指定的表达式。两者的不同之处在于，简单 `CASE` 表达式最初的 `CASE <表达式>` 也会作为求值的对象。

### 3.3.`CASE` 表达式的使用方法

```sql
SELECT product_name,
       CASE WHEN product_type = '衣服'
            THEN 'A:' || product_type
            WHEN product_type = '办公用品'
            THEN 'B:' || product_type
            WHEN product_type = '厨房用具'
            THEN 'C:' || product_type
            ELSE NULL
       END AS abc_product_type
FROM Product;
```

`ELSE` 子句也可以省略不写，这时会被默认为 `ELSE NULL`。此外，`CASE` 表达式最后的 `END` 是不能省略的。

`CASE` 表达式的便利之处就在于它是一个表达式。之所以这么说，是因为表达式可以书写在任意位置。

- **行列转换**

```sql
SELECT SUM(CASE WHEN product_type = '衣服'
                THEN sale_price ELSE 0 END) AS sum_price_clothes,
       SUM(CASE WHEN product_type = '厨房用具'
                THEN sale_price ELSE 0 END) AS sum_price_kitchen,
       SUM(CASE WHEN product_type = '办公用品'
                THEN sale_price ELSE 0 END) AS sum_price_office
  FROM Product;
```
